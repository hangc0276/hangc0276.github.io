<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 9.3.0 (459506)"/><meta name="author" content="hangc0276@163.com"/><meta name="created" content="2020-03-22 06:13:55 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2020-03-22 06:21:53 +0000"/><meta name="content-class" content="yinxiang.markdown"/><title>Bookkeeper NetWork IO</title></head><body><div style="font-size: 14px; margin: 0; padding: 0; width: 100%;"><h3 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;">Bookkeeper NetWork IO图解</h3>
<p style="line-height: 160%; box-sizing: content-box; margin: 10px 0; color: #333;"><img src="Bookkeeper%20NetWork%20IO.resources/73C1864C-4E6B-4852-88C0-26056975D8CC.png" height="246" width="500"/></p>
<h3 style="line-height: 160%; box-sizing: content-box; font-weight: 700; font-size: 27px; color: #333;">请求流程</h3>
<ol style="line-height: 160%; box-sizing: content-box; display: block; padding-left: 30px; margin: 6px 0 10px; color: #333; list-style-type: decimal;">
<li style="line-height: 160%; box-sizing: content-box;">Bookie Server启动过程中，首先启动Netty Server（epoll），分配2 * cpu个thread Channel处理网络请求，绑定BookieRequestProcessor实例，监听网络端口</li>
<li style="line-height: 160%; box-sizing: content-box;">当Client有请求到Netty Server时，首先根据sessionId将Request加入到对于的thread Channel中</li>
<li style="line-height: 160%; box-sizing: content-box;">Thread Channel相应线程对Request进行一系列预处理工作：LengthFieldBasedFrameDecoder、LengthFieldPrepender、RequestDecoder、ResponseEncoder、 ServerSideHandler、requestHandler</li>
<li style="line-height: 160%; box-sizing: content-box;">在requestHandler: processRequest中根据请求类型调用不同类型请求的处理操作：ADD_ENTRY、READ_ENTRY、FORCE_LEDGER、AUTH、WRITE_LAC、READ_LAC、GET_BOOKIE_INFO、START_TLS。（这里我只拿最常用的ADD_ENTRY和READ_ENTRY进行分析）</li>
<li style="line-height: 160%; box-sizing: content-box;">ADD_ENTRY<br/>
5.1 在pulsar Client的配置中，并没有为add_entry操作分配单独的线程池，而是直接使用Netty自身的线程池（这样会不会阻塞其他类型的操作）<br/>
5.2 将request和channel传给WriteEntryProcessorV3生成相应实例，并调用run方法启动<br/>
5.3 Run方法中首先调用getAddResponse将Entry写入bookie journal，然后返回处理结果<br/>
5.4 将处理结果封装到sendResponse中，调用writeChannel写出到netty thread channel，并发送给客户端</li>
<li style="line-height: 160%; box-sizing: content-box;">READ_ENTRY<br/>
6.1 将Read Request封装成ReadEntryProcessorV3实例，按照读取的LedgerId对线程池大小取模选择一个Read处理线程，并将Read Request加入该线程的处理队列中（每个线程拥有独立的队列，长度默认配置为2500，如果排队长度超过最大值则会被阻塞）<br/>
6.2 Read处理线程不断从自己的队列中取出Read Request，调用ReadEntryProcessorV3实例的safeRun方法进行数据读取<br/>
6.3 数据读取过程是根据LedgerId选择对于的Ledger实例将entry data读取回来，并塞入readResponse中<br/>
6.4 将Read Response返回给Netty Thread Channel，由Netty统一发送给客户端</li>
</ol>
</div><center style="display:none !important;visibility:collapse !important;height:0 !important;white-space:nowrap;width:100%;overflow:hidden">%23%23%23%20Bookkeeper%20NetWork%20IO%E5%9B%BE%E8%A7%A3%0A!%5Bc25b443c5788a75f96e6c79a77a1782f.png%5D(evernotecid%3A%2F%2F6AF3FDE5-F2AC-4334-9135-DDE377491CE0%2Fappyinxiangcom%2F6758006%2FENResource%2Fp719)%0A%0A%23%23%23%20%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B%0A1.%20Bookie%20Server%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E4%B8%AD%EF%BC%8C%E9%A6%96%E5%85%88%E5%90%AF%E5%8A%A8Netty%20Server%EF%BC%88epoll%EF%BC%89%EF%BC%8C%E5%88%86%E9%85%8D2%20%5C*%20cpu%E4%B8%AAthread%20Channel%E5%A4%84%E7%90%86%E7%BD%91%E7%BB%9C%E8%AF%B7%E6%B1%82%EF%BC%8C%E7%BB%91%E5%AE%9ABookieRequestProcessor%E5%AE%9E%E4%BE%8B%EF%BC%8C%E7%9B%91%E5%90%AC%E7%BD%91%E7%BB%9C%E7%AB%AF%E5%8F%A3%0A2.%20%E5%BD%93Client%E6%9C%89%E8%AF%B7%E6%B1%82%E5%88%B0Netty%20Server%E6%97%B6%EF%BC%8C%E9%A6%96%E5%85%88%E6%A0%B9%E6%8D%AEsessionId%E5%B0%86Request%E5%8A%A0%E5%85%A5%E5%88%B0%E5%AF%B9%E4%BA%8E%E7%9A%84thread%20Channel%E4%B8%AD%0A3.%20Thread%20Channel%E7%9B%B8%E5%BA%94%E7%BA%BF%E7%A8%8B%E5%AF%B9Request%E8%BF%9B%E8%A1%8C%E4%B8%80%E7%B3%BB%E5%88%97%E9%A2%84%E5%A4%84%E7%90%86%E5%B7%A5%E4%BD%9C%EF%BC%9ALengthFieldBasedFrameDecoder%E3%80%81LengthFieldPrepender%E3%80%81RequestDecoder%E3%80%81ResponseEncoder%E3%80%81%20ServerSideHandler%E3%80%81requestHandler%0A4.%20%E5%9C%A8requestHandler%3A%20processRequest%E4%B8%AD%E6%A0%B9%E6%8D%AE%E8%AF%B7%E6%B1%82%E7%B1%BB%E5%9E%8B%E8%B0%83%E7%94%A8%E4%B8%8D%E5%90%8C%E7%B1%BB%E5%9E%8B%E8%AF%B7%E6%B1%82%E7%9A%84%E5%A4%84%E7%90%86%E6%93%8D%E4%BD%9C%EF%BC%9AADD_ENTRY%E3%80%81READ_ENTRY%E3%80%81FORCE_LEDGER%E3%80%81AUTH%E3%80%81WRITE_LAC%E3%80%81READ_LAC%E3%80%81GET_BOOKIE_INFO%E3%80%81START_TLS%E3%80%82%EF%BC%88%E8%BF%99%E9%87%8C%E6%88%91%E5%8F%AA%E6%8B%BF%E6%9C%80%E5%B8%B8%E7%94%A8%E7%9A%84ADD_ENTRY%E5%92%8CREAD_ENTRY%E8%BF%9B%E8%A1%8C%E5%88%86%E6%9E%90%EF%BC%89%0A5.%20ADD_ENTRY%0A%20%20%20%205.1%20%E5%9C%A8pulsar%20Client%E7%9A%84%E9%85%8D%E7%BD%AE%E4%B8%AD%EF%BC%8C%E5%B9%B6%E6%B2%A1%E6%9C%89%E4%B8%BAadd_entry%E6%93%8D%E4%BD%9C%E5%88%86%E9%85%8D%E5%8D%95%E7%8B%AC%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%B1%A0%EF%BC%8C%E8%80%8C%E6%98%AF%E7%9B%B4%E6%8E%A5%E4%BD%BF%E7%94%A8Netty%E8%87%AA%E8%BA%AB%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%B1%A0%EF%BC%88%E8%BF%99%E6%A0%B7%E4%BC%9A%E4%B8%8D%E4%BC%9A%E9%98%BB%E5%A1%9E%E5%85%B6%E4%BB%96%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%93%8D%E4%BD%9C%EF%BC%89%0A%20%20%20%205.2%20%E5%B0%86request%E5%92%8Cchannel%E4%BC%A0%E7%BB%99WriteEntryProcessorV3%E7%94%9F%E6%88%90%E7%9B%B8%E5%BA%94%E5%AE%9E%E4%BE%8B%EF%BC%8C%E5%B9%B6%E8%B0%83%E7%94%A8run%E6%96%B9%E6%B3%95%E5%90%AF%E5%8A%A8%0A%20%20%20%205.3%20Run%E6%96%B9%E6%B3%95%E4%B8%AD%E9%A6%96%E5%85%88%E8%B0%83%E7%94%A8getAddResponse%E5%B0%86Entry%E5%86%99%E5%85%A5bookie%20journal%EF%BC%8C%E7%84%B6%E5%90%8E%E8%BF%94%E5%9B%9E%E5%A4%84%E7%90%86%E7%BB%93%E6%9E%9C%0A%20%20%20%205.4%20%E5%B0%86%E5%A4%84%E7%90%86%E7%BB%93%E6%9E%9C%E5%B0%81%E8%A3%85%E5%88%B0sendResponse%E4%B8%AD%EF%BC%8C%E8%B0%83%E7%94%A8writeChannel%E5%86%99%E5%87%BA%E5%88%B0netty%20thread%20channel%EF%BC%8C%E5%B9%B6%E5%8F%91%E9%80%81%E7%BB%99%E5%AE%A2%E6%88%B7%E7%AB%AF%0A6.%20READ_ENTRY%0A%20%20%20%206.1%20%E5%B0%86Read%20Request%E5%B0%81%E8%A3%85%E6%88%90ReadEntryProcessorV3%E5%AE%9E%E4%BE%8B%EF%BC%8C%E6%8C%89%E7%85%A7%E8%AF%BB%E5%8F%96%E7%9A%84LedgerId%E5%AF%B9%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%A4%A7%E5%B0%8F%E5%8F%96%E6%A8%A1%E9%80%89%E6%8B%A9%E4%B8%80%E4%B8%AARead%E5%A4%84%E7%90%86%E7%BA%BF%E7%A8%8B%EF%BC%8C%E5%B9%B6%E5%B0%86Read%20Request%E5%8A%A0%E5%85%A5%E8%AF%A5%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%A4%84%E7%90%86%E9%98%9F%E5%88%97%E4%B8%AD%EF%BC%88%E6%AF%8F%E4%B8%AA%E7%BA%BF%E7%A8%8B%E6%8B%A5%E6%9C%89%E7%8B%AC%E7%AB%8B%E7%9A%84%E9%98%9F%E5%88%97%EF%BC%8C%E9%95%BF%E5%BA%A6%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE%E4%B8%BA2500%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%8E%92%E9%98%9F%E9%95%BF%E5%BA%A6%E8%B6%85%E8%BF%87%E6%9C%80%E5%A4%A7%E5%80%BC%E5%88%99%E4%BC%9A%E8%A2%AB%E9%98%BB%E5%A1%9E%EF%BC%89%0A%20%20%20%206.2%20Read%E5%A4%84%E7%90%86%E7%BA%BF%E7%A8%8B%E4%B8%8D%E6%96%AD%E4%BB%8E%E8%87%AA%E5%B7%B1%E7%9A%84%E9%98%9F%E5%88%97%E4%B8%AD%E5%8F%96%E5%87%BARead%20Request%EF%BC%8C%E8%B0%83%E7%94%A8ReadEntryProcessorV3%E5%AE%9E%E4%BE%8B%E7%9A%84safeRun%E6%96%B9%E6%B3%95%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%8F%96%0A%20%20%20%206.3%20%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%8F%96%E8%BF%87%E7%A8%8B%E6%98%AF%E6%A0%B9%E6%8D%AELedgerId%E9%80%89%E6%8B%A9%E5%AF%B9%E4%BA%8E%E7%9A%84Ledger%E5%AE%9E%E4%BE%8B%E5%B0%86entry%20data%E8%AF%BB%E5%8F%96%E5%9B%9E%E6%9D%A5%EF%BC%8C%E5%B9%B6%E5%A1%9E%E5%85%A5readResponse%E4%B8%AD%0A%20%20%20%206.4%20%E5%B0%86Read%20Response%E8%BF%94%E5%9B%9E%E7%BB%99Netty%20Thread%20Channel%EF%BC%8C%E7%94%B1Netty%E7%BB%9F%E4%B8%80%E5%8F%91%E9%80%81%E7%BB%99%E5%AE%A2%E6%88%B7%E7%AB%AF%0A%0A</center></body></html>